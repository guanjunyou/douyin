## 点赞模块性能优化

### 前言

​	点赞模块主要涉及到的业务有：

- 给视频点赞或者取消点赞
- 获取用户的点赞视频列表

​	以上业务我们现阶段都是使用数据库直接交互的方式，直接访问数据库的性能相对较差，并且相应时间长对用户体验不好。于是，为了提高性能，我们将引入redis、channel以及消息队列（**Rabbitmq**）进行性能提升。同时对于一些循环，我们可以使用协程进行优化。**在模块内通信我们使用channel,模块间通信使用消息队列**。下文中**channel**统一使用管道来称呼。**文中提供的思路不一定切实可行，大家根据具体实际情况适当调整。**

### 增删查改约定

#### 	查询

​	查询数据之前先从redis中查，redis中查不到再从数据库中查询，写入缓存中并返回给用户。同时为了解决**缓存穿透**问题，我们可以使用写空值或者布隆过滤的方法。

#### 	新增、删除、更新

​	新增或者更新操作，再发送数据到队列中，监听到消息后调用服务先执行对数据库的修改操作，再更新缓存。删除操作，删除的话先删缓存再发送数据到队列，消费的时候再删数据库，删完数据库再删一次缓存。延迟双删保证缓存与数据库的一致。

### 数据结构设计

- key(userId) set(videoId)：用于存储用户点赞的视频id
- LikeRabbitMq

### 点赞性能优化

​	0. 添加分布式锁，防止重复点赞或取消点赞

​	1. 先查看redis中有没有这个videoId，没有的话进一步查询数据库

​	2. 当点赞时，将消息分别放入管道中和LikeRabbitMq后，主程序直接返回成功

​	3. 子协程收到管道中的消息后，先往like表和Video中增加数据，之后往redis中添加缓存

​	4. User监听到LikeRabbitMq中的消息后，更新当前用户的favorite_count、视频作者的total_favorited

### 取消点赞性能优化

​	0. 添加分布式锁，防止重复点赞或取消点赞

​	1. 先查看redis中有没有这个videoId，没有的话进一步查询数据库

​	2.将消息分别放入管道中和LikeRabbitMq后删除redis相应数据，主程序直接返回成功

​	3.子协程收到管道中的消息后，往like表和Video表中删除数据后，删除redis中对应的数据

​	4.User监听到LikeRabbitMq中的消息后，更新当前用户的favorite_count、视频作者的total_favorited

### 获取用户的点赞视频列表

​	直接从redis中根据key：userId进行查询。根据其是否存在，分为两种情况。若存在，则直接统计value中元素的数量，返回即可；若不存在，则先查询数据库，然后写入缓存并返回。

## 评论模块性能优化

### 前言

评论模块主要涉及的业务有：

- 发表评论或者删除评论
- 获取评论列表

以上业务中现阶段，我们都是通过直接访问数据库的方式实现的，特别是在获取评论列表这一功能中，当数据量大的时候直接查询数据库性能会特别差。于是，为了提高性能，我们将引入redis、channel以及消息队列（**Rabbitmq**）进行性能提升。**在模块内通信我们使用channel,模块间通信使用消息队列**。同时对于一些循环，我们可以使用协程进行优化。下文中统一使用**队列**来称呼，涉及到具体实现再自己区分。**文中提供的思路不一定切实可行，大家根据具体实际情况适当调整。**

### 增删查改约定

#### 	查询

​	查询数据之前先从redis中查，redis中查不到再从数据库中查询，写入缓存中并返回给用户。同时为了解决**缓存穿透**问题，我们可以使用写空值或者布隆过滤的方法。

#### 	新增、删除、更新

​	新增或者更新操作，再发送数据到队列中，监听到消息后调用服务先执行对数据库的修改操作，再更新缓存。删除操作，删除的话先删缓存再发送数据到队列，消费的时候再删数据库，删完数据库再删一次缓存。延迟双删保证缓存与数据库的一致。

### 数据结构设计
  采用两级存储结构
​	key(videoId)-zset(评论Id,score值使用创建时间)
  key(评论id)--string(评论的实例对象)
  查询时查出评论id后，可以根据第二种数据结构查出评论的实体
  具体在设计key时需要添加公共前缀，如comment

### 发表评论性能优化
​	1. 将消息分别放入channel中后，查询User封装结果后主程序直接返回

​	2. 子协程收到channel中的消息后，先往comment表和Video中增加数据，之后往redis中两种数据结构添加缓存，

### 删除评论性能优化

​	1. 先查看redis中有没有这个评论，没有的话进一步查询数据库，防止构造请求删除不存在的评论

​	2. 将消息分别放入channel中后，主程序直接返回

​	3. 子协程收到channel中的消息后，先更新comment表和Video表的数据，之后删除redis中相应的缓存

### 查看评论列表优化

​	直接从redis中根据key：videoId进行查询第一种数据结构。根据其是否存在，分为两种情况。若存在，将每一个评论的实体类从第二种数据结构中查出来拼接返回；若不存在，则先查询数据库，然后写入缓存并返回。
